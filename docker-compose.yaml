services:
  redis:
    image: redis:7-alpine
    container_name: streaming-wars-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # PHASE 1: Historical Backfill Producer
  # Uncomment this service during Phase 1
  producer-batch:
    build: .
    container_name: streaming-wars-producer-batch
    command: python producer_integrated.py
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./data:/data
    environment:
      - REDIS_HOST=redis
      - NUM_SHOWS=200
      - SLEEP_BETWEEN_YEARS=2
    # Comment out this service after Phase 1 completes
    # profiles: ["phase1"]

  # PHASE 2: Real-Time Streaming Producer
  # Uncomment this service during Phase 2
  # producer-stream:
  #   build: .
  #   container_name: streaming-wars-producer-stream
  #   command: python producer_streaming.py
  #   depends_on:
  #     redis:
  #       condition: service_healthy
  #   volumes:
  #     - ./data:/data
  #   environment:
  #     - REDIS_HOST=redis
  #     - STREAM_INTERVAL=60
  #     - BACKFILL_HISTORICAL=false
  #   profiles: ["phase2"]

  consumer:
    build: .
    container_name: streaming-wars-consumer
    command: python consumer.py
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./data:/data
    environment:
      - REDIS_HOST=redis
      - POP_BATCH=200
      - SNAPSHOT_EVERY=5000
    restart: unless-stopped

  dashboard:
    build: .
    container_name: streaming-wars-dashboard
    command: streamlit run app_enhanced.py --server.port=8501 --server.address=0.0.0.0
    ports:
      - "8501:8501"
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis
    restart: unless-stopped

volumes:
  redis-data: